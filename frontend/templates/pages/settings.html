{% extends "base.html" %}

{% block title %}Settings - EVE Sentinel{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-gear me-2"></i>Settings</h1>
    <p class="text-muted mb-0">Manage your preferences and notifications</p>
</div>

<div class="row g-4">
    <!-- Email Notifications -->
    <div class="col-lg-6">
        <div class="card card-sentinel">
            <div class="card-header">
                <i class="bi bi-envelope me-2"></i>Email Notifications
            </div>
            <div class="card-body">
                <form id="email-form">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="email" placeholder="your@email.com"
                               style="background: var(--eve-bg); border-color: var(--eve-border); color: var(--eve-text);">
                        <small class="text-muted">Leave blank to disable email notifications</small>
                    </div>

                    <hr style="border-color: var(--eve-border);">

                    <h6 class="mb-3">Notification Preferences</h6>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="email-watchlist" checked>
                        <label class="form-check-label" for="email-watchlist">
                            <strong>Watchlist Changes</strong>
                            <br><small class="text-muted">Notify when a watched character's risk level changes</small>
                        </label>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="email-red" checked>
                        <label class="form-check-label" for="email-red">
                            <strong>Red Risk Alerts</strong>
                            <br><small class="text-muted">Notify for high-risk (RED) changes</small>
                        </label>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="email-yellow">
                        <label class="form-check-label" for="email-yellow">
                            <strong>Yellow Risk Alerts</strong>
                            <br><small class="text-muted">Notify for moderate-risk (YELLOW) changes</small>
                        </label>
                    </div>

                    <button type="submit" class="btn btn-sentinel">
                        <i class="bi bi-check-lg me-1"></i>Save Email Settings
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Account Info -->
    <div class="col-lg-6">
        <div class="card card-sentinel">
            <div class="card-header">
                <i class="bi bi-person me-2"></i>Account Information
            </div>
            <div class="card-body" id="account-info">
                <div class="text-center py-4">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span class="ms-2">Loading...</span>
                </div>
            </div>
        </div>

        <!-- API Access -->
        <div class="card card-sentinel mt-4">
            <div class="card-header">
                <i class="bi bi-key me-2"></i>API Access
            </div>
            <div class="card-body">
                <p class="text-muted small">
                    API endpoints are available at <code>/api/v1/</code>.
                    See the <a href="/docs" target="_blank">API documentation</a> for details.
                </p>
                <div class="alert alert-info" style="background: rgba(13, 202, 240, 0.1); border-color: var(--eve-border);">
                    <i class="bi bi-info-circle me-2"></i>
                    API key authentication can be enabled by administrators.
                </div>
            </div>
        </div>

        <!-- Theme Preferences -->
        <div class="card card-sentinel mt-4">
            <div class="card-header">
                <i class="bi bi-palette me-2"></i>Display Preferences
            </div>
            <div class="card-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="compact-mode" onchange="toggleCompactMode()">
                    <label class="form-check-label" for="compact-mode">
                        <strong>Compact Mode</strong>
                        <br><small class="text-muted">Reduce padding and spacing</small>
                    </label>
                </div>

                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="auto-refresh">
                    <label class="form-check-label" for="auto-refresh">
                        <strong>Auto-Refresh Dashboard</strong>
                        <br><small class="text-muted">Automatically refresh data every 5 minutes</small>
                    </label>
                </div>

                <div class="mb-3">
                    <label for="page-size" class="form-label">Default Page Size</label>
                    <select class="form-select" id="page-size"
                            style="background: var(--eve-bg); border-color: var(--eve-border); color: var(--eve-text);">
                        <option value="25">25 items</option>
                        <option value="50">50 items</option>
                        <option value="100">100 items</option>
                    </select>
                </div>

                <button class="btn btn-outline-sentinel" onclick="saveDisplayPrefs()">
                    <i class="bi bi-check-lg me-1"></i>Save Display Settings
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Danger Zone -->
<div class="card card-sentinel mt-4" style="border-color: var(--bs-danger);">
    <div class="card-header" style="background: rgba(220, 53, 69, 0.1);">
        <i class="bi bi-exclamation-triangle text-danger me-2"></i>Danger Zone
    </div>
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col">
                <strong>Clear All Personal Data</strong>
                <p class="mb-0 text-muted small">This will remove your email and notification preferences. Your account will remain active.</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-danger" onclick="clearPersonalData()">
                    <i class="bi bi-trash me-1"></i>Clear Data
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentUserId = null;

// Load user info from session
async function loadAccountInfo() {
    try {
        // Try to get current user from session
        const response = await fetch('/api/v1/auth/me');
        if (response.ok) {
            const user = await response.json();
            currentUserId = user.character_id;

            document.getElementById('account-info').innerHTML = `
                <div class="d-flex align-items-center mb-3">
                    <img src="https://images.evetech.net/characters/${user.character_id}/portrait?size=64"
                         class="rounded me-3" alt="${user.character_name}">
                    <div>
                        <h5 class="mb-0">${user.character_name}</h5>
                        <small class="text-muted">ID: ${user.character_id}</small>
                    </div>
                </div>
                <hr style="border-color: var(--eve-border);">
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Role</small>
                        <p class="mb-0"><span class="badge bg-${user.role === 'admin' ? 'danger' : user.role === 'recruiter' ? 'warning text-dark' : 'secondary'}">${user.role}</span></p>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Status</small>
                        <p class="mb-0"><span class="badge bg-${user.is_active ? 'success' : 'secondary'}">${user.is_active ? 'Active' : 'Inactive'}</span></p>
                    </div>
                </div>
            `;

            // Load email preferences
            loadEmailPrefs(user.character_id);
        } else {
            document.getElementById('account-info').innerHTML = `
                <div class="text-center py-4">
                    <i class="bi bi-person-x" style="font-size: 2rem; opacity: 0.5;"></i>
                    <p class="mb-2 mt-2">Not logged in</p>
                    <a href="/api/v1/auth/login" class="btn btn-sentinel">
                        <i class="bi bi-box-arrow-in-right me-1"></i>Login with EVE SSO
                    </a>
                </div>
            `;
        }
    } catch (e) {
        document.getElementById('account-info').innerHTML = `
            <div class="text-center py-4 text-muted">
                <p>Could not load account info</p>
                <a href="/api/v1/auth/login" class="btn btn-outline-sentinel">Login</a>
            </div>
        `;
    }
}

// Load email preferences
async function loadEmailPrefs(userId) {
    try {
        const response = await fetch(`/api/v1/users/${userId}/email-preferences`);
        if (response.ok) {
            const prefs = await response.json();
            document.getElementById('email').value = prefs.email || '';
            document.getElementById('email-watchlist').checked = prefs.email_on_watchlist_change;
            document.getElementById('email-red').checked = prefs.email_on_red_alert;
            document.getElementById('email-yellow').checked = prefs.email_on_yellow_alert;
        }
    } catch (e) {
        console.error('Failed to load email preferences:', e);
    }
}

// Save email settings
document.getElementById('email-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    if (!currentUserId) {
        alert('Please log in to save settings');
        return;
    }

    try {
        const response = await fetch(`/api/v1/users/${currentUserId}/email-preferences`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: document.getElementById('email').value || null,
                email_on_watchlist_change: document.getElementById('email-watchlist').checked,
                email_on_red_alert: document.getElementById('email-red').checked,
                email_on_yellow_alert: document.getElementById('email-yellow').checked,
            }),
        });

        if (response.ok) {
            alert('Email settings saved successfully!');
        } else {
            throw new Error('Failed to save');
        }
    } catch (e) {
        alert('Failed to save email settings: ' + e.message);
    }
});

// Toggle compact mode
function toggleCompactMode() {
    const compact = document.getElementById('compact-mode').checked;
    localStorage.setItem('compactMode', compact);
    document.body.classList.toggle('compact-mode', compact);
}

// Save display preferences
function saveDisplayPrefs() {
    const prefs = {
        compactMode: document.getElementById('compact-mode').checked,
        autoRefresh: document.getElementById('auto-refresh').checked,
        pageSize: document.getElementById('page-size').value,
    };
    localStorage.setItem('displayPrefs', JSON.stringify(prefs));
    alert('Display settings saved!');
}

// Load display preferences
function loadDisplayPrefs() {
    const prefs = JSON.parse(localStorage.getItem('displayPrefs') || '{}');
    if (prefs.compactMode) {
        document.getElementById('compact-mode').checked = true;
        document.body.classList.add('compact-mode');
    }
    if (prefs.autoRefresh) {
        document.getElementById('auto-refresh').checked = true;
    }
    if (prefs.pageSize) {
        document.getElementById('page-size').value = prefs.pageSize;
    }
}

// Clear personal data
async function clearPersonalData() {
    if (!currentUserId) {
        alert('Please log in first');
        return;
    }

    if (!confirm('Are you sure you want to clear all your personal data? This cannot be undone.')) {
        return;
    }

    try {
        await fetch(`/api/v1/users/${currentUserId}/email-preferences`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: null,
                email_on_watchlist_change: true,
                email_on_red_alert: true,
                email_on_yellow_alert: false,
            }),
        });

        localStorage.removeItem('displayPrefs');
        alert('Personal data cleared. Page will reload.');
        location.reload();
    } catch (e) {
        alert('Failed to clear data: ' + e.message);
    }
}

// Initialize
loadAccountInfo();
loadDisplayPrefs();
</script>
{% endblock %}
