{% extends "base.html" %}

{% block title %}Compare Characters - EVE Sentinel{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-arrow-left-right me-2"></i>Compare Characters</h1>
    <p class="text-muted mb-0">Side-by-side analysis comparison</p>
</div>

<!-- Comparison Form -->
<div class="card card-sentinel mb-4">
    <div class="card-header">
        <i class="bi bi-search me-2"></i>Select Characters to Compare
    </div>
    <div class="card-body">
        <form id="compare-form">
            <div class="row g-3">
                <div class="col-md-5">
                    <label class="form-label">Character 1</label>
                    <input type="text" class="form-control form-control-sentinel"
                           id="char1-input" placeholder="Character name or ID..." required>
                    <select class="form-select form-select-sentinel mt-2" id="char1-select">
                        <option value="">Or select from recent reports...</option>
                        {% for report in recent_reports %}
                        <option value="{{ report.character_id }}">
                            {{ report.character_name }} ({{ report.overall_risk.value }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-center justify-content-center">
                    <i class="bi bi-arrow-left-right fs-2 text-muted"></i>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Character 2</label>
                    <input type="text" class="form-control form-control-sentinel"
                           id="char2-input" placeholder="Character name or ID..." required>
                    <select class="form-select form-select-sentinel mt-2" id="char2-select">
                        <option value="">Or select from recent reports...</option>
                        {% for report in recent_reports %}
                        <option value="{{ report.character_id }}">
                            {{ report.character_name }} ({{ report.overall_risk.value }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="mt-3 text-center">
                <button type="submit" class="btn btn-sentinel btn-lg">
                    <i class="bi bi-arrow-left-right me-2"></i>Compare
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Comparison Results (populated via JavaScript) -->
<div id="comparison-result" style="display: none;">
    <!-- Header with names and risk -->
    <div class="row g-3 mb-4">
        <div class="col-md-5">
            <div class="card card-sentinel h-100" id="char1-card">
                <div class="card-body text-center">
                    <h4 id="char1-name">-</h4>
                    <div id="char1-risk" class="fs-3 mb-2">-</div>
                    <div class="text-muted">
                        Confidence: <span id="char1-confidence">-</span>%
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2 d-flex align-items-center justify-content-center">
            <div id="risk-comparison" class="text-center">
                <i class="bi bi-equals fs-1 text-muted"></i>
            </div>
        </div>
        <div class="col-md-5">
            <div class="card card-sentinel h-100" id="char2-card">
                <div class="card-body text-center">
                    <h4 id="char2-name">-</h4>
                    <div id="char2-risk" class="fs-3 mb-2">-</div>
                    <div class="text-muted">
                        Confidence: <span id="char2-confidence">-</span>%
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Flag Statistics -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card card-sentinel">
                <div class="card-header bg-danger bg-opacity-25">
                    <i class="bi bi-exclamation-triangle me-2"></i>Red Flags
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-5">
                            <div class="fs-2 text-danger" id="char1-red">0</div>
                            <small class="text-muted" id="char1-red-name">Char 1</small>
                        </div>
                        <div class="col-2 d-flex align-items-center justify-content-center">
                            <span class="text-muted">vs</span>
                        </div>
                        <div class="col-5">
                            <div class="fs-2 text-danger" id="char2-red">0</div>
                            <small class="text-muted" id="char2-red-name">Char 2</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-sentinel">
                <div class="card-header bg-warning bg-opacity-25">
                    <i class="bi bi-exclamation-circle me-2"></i>Yellow Flags
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-5">
                            <div class="fs-2 text-warning" id="char1-yellow">0</div>
                            <small class="text-muted" id="char1-yellow-name">Char 1</small>
                        </div>
                        <div class="col-2 d-flex align-items-center justify-content-center">
                            <span class="text-muted">vs</span>
                        </div>
                        <div class="col-5">
                            <div class="fs-2 text-warning" id="char2-yellow">0</div>
                            <small class="text-muted" id="char2-yellow-name">Char 2</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-sentinel">
                <div class="card-header bg-success bg-opacity-25">
                    <i class="bi bi-check-circle me-2"></i>Green Flags
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-5">
                            <div class="fs-2 text-success" id="char1-green">0</div>
                            <small class="text-muted" id="char1-green-name">Char 1</small>
                        </div>
                        <div class="col-2 d-flex align-items-center justify-content-center">
                            <span class="text-muted">vs</span>
                        </div>
                        <div class="col-5">
                            <div class="fs-2 text-success" id="char2-green">0</div>
                            <small class="text-muted" id="char2-green-name">Char 2</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Metrics Comparison Chart -->
    <div class="row g-3 mb-4" id="metrics-section" style="display: none;">
        <div class="col-lg-6">
            <div class="card card-sentinel h-100">
                <div class="card-header">
                    <i class="bi bi-radar me-2"></i>Metrics Comparison
                </div>
                <div class="card-body">
                    <canvas id="radarChart" height="250"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card card-sentinel h-100">
                <div class="card-header">
                    <i class="bi bi-table me-2"></i>Detailed Metrics
                </div>
                <div class="card-body p-0">
                    <table class="table table-sentinel mb-0">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th id="metrics-char1-header" class="text-end">Char 1</th>
                                <th id="metrics-char2-header" class="text-end">Char 2</th>
                            </tr>
                        </thead>
                        <tbody id="metrics-table">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Corporation History Comparison -->
    <div class="row g-3 mb-4" id="corp-history-section" style="display: none;">
        <div class="col-12">
            <div class="card card-sentinel">
                <div class="card-header">
                    <i class="bi bi-building me-2"></i>Corporation History Comparison
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-intersect me-1"></i>Shared Corporations
                                <span class="badge bg-secondary ms-1" id="shared-corps-count">0</span>
                            </h6>
                            <div id="shared-corps" class="corps-list" style="max-height: 200px; overflow-y: auto;">
                                <p class="text-muted small mb-0">No shared corporations</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-box-arrow-left me-1"></i>Only <span id="corps-char1-name">Char 1</span>
                                <span class="badge bg-secondary ms-1" id="unique-corps-1-count">0</span>
                            </h6>
                            <div id="unique-corps-1" class="corps-list" style="max-height: 200px; overflow-y: auto;">
                                <p class="text-muted small mb-0">No unique corporations</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-box-arrow-right me-1"></i>Only <span id="corps-char2-name">Char 2</span>
                                <span class="badge bg-secondary ms-1" id="unique-corps-2-count">0</span>
                            </h6>
                            <div id="unique-corps-2" class="corps-list" style="max-height: 200px; overflow-y: auto;">
                                <p class="text-muted small mb-0">No unique corporations</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Flag Details -->
    <div class="row g-3">
        <!-- Shared Flags -->
        <div class="col-md-4">
            <div class="card card-sentinel h-100">
                <div class="card-header">
                    <i class="bi bi-intersect me-2"></i>Shared Flags
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush" id="shared-flags">
                        <li class="list-group-item text-muted text-center py-4">No shared flags</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Only in Character 1 -->
        <div class="col-md-4">
            <div class="card card-sentinel h-100">
                <div class="card-header">
                    <i class="bi bi-box-arrow-left me-2"></i>Only in <span id="only1-header">Character 1</span>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush" id="only-in-1">
                        <li class="list-group-item text-muted text-center py-4">No unique flags</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Only in Character 2 -->
        <div class="col-md-4">
            <div class="card card-sentinel h-100">
                <div class="card-header">
                    <i class="bi bi-box-arrow-right me-2"></i>Only in <span id="only2-header">Character 2</span>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush" id="only-in-2">
                        <li class="list-group-item text-muted text-center py-4">No unique flags</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- View Full Reports -->
    <div class="mt-4 text-center">
        <a id="view-report-1" href="#" class="btn btn-outline-sentinel me-2">
            <i class="bi bi-file-text me-1"></i>View Report 1
        </a>
        <a id="view-report-2" href="#" class="btn btn-outline-sentinel">
            <i class="bi bi-file-text me-1"></i>View Report 2
        </a>
    </div>
</div>

<!-- Loading State -->
<div id="loading-state" class="text-center py-5" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Comparing characters...</p>
</div>

<!-- Error State -->
<div id="error-state" class="alert alert-danger" style="display: none;">
    <i class="bi bi-exclamation-triangle me-2"></i>
    <span id="error-message">An error occurred</span>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let radarChart = null;

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('compare-form');
    const char1Input = document.getElementById('char1-input');
    const char2Input = document.getElementById('char2-input');
    const char1Select = document.getElementById('char1-select');
    const char2Select = document.getElementById('char2-select');

    // Sync select to input
    char1Select.addEventListener('change', function() {
        if (this.value) char1Input.value = this.value;
    });
    char2Select.addEventListener('change', function() {
        if (this.value) char2Input.value = this.value;
    });

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const char1 = char1Input.value.trim();
        const char2 = char2Input.value.trim();

        if (!char1 || !char2) return;

        // Show loading
        document.getElementById('comparison-result').style.display = 'none';
        document.getElementById('error-state').style.display = 'none';
        document.getElementById('loading-state').style.display = 'block';

        try {
            const response = await fetch('/api/v1/reports/compare', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    character_id_1: isNaN(char1) ? null : parseInt(char1),
                    character_id_2: isNaN(char2) ? null : parseInt(char2),
                }),
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'Comparison failed');
            }

            const data = await response.json();
            displayComparison(data);

        } catch (error) {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('error-message').textContent = error.message;
            document.getElementById('error-state').style.display = 'block';
        }
    });

    function displayComparison(data) {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('comparison-result').style.display = 'block';

        // Character 1 info
        document.getElementById('char1-name').textContent = data.character_1_name;
        document.getElementById('char1-confidence').textContent = Math.round(data.report_1_confidence * 100);
        setRiskBadge('char1-risk', data.report_1_risk);

        // Character 2 info
        document.getElementById('char2-name').textContent = data.character_2_name;
        document.getElementById('char2-confidence').textContent = Math.round(data.report_2_confidence * 100);
        setRiskBadge('char2-risk', data.report_2_risk);

        // Risk comparison icon
        const riskComp = document.getElementById('risk-comparison');
        if (data.risk_difference === 'same') {
            riskComp.innerHTML = '<i class="bi bi-equals fs-1 text-muted"></i><div class="small text-muted">Same Risk</div>';
        } else if (data.risk_difference === '1_higher') {
            riskComp.innerHTML = '<i class="bi bi-arrow-left fs-1 text-danger"></i><div class="small text-muted">Higher Risk</div>';
        } else {
            riskComp.innerHTML = '<i class="bi bi-arrow-right fs-1 text-danger"></i><div class="small text-muted">Higher Risk</div>';
        }

        // Flag counts
        document.getElementById('char1-red').textContent = data.red_flags_1;
        document.getElementById('char2-red').textContent = data.red_flags_2;
        document.getElementById('char1-yellow').textContent = data.yellow_flags_1;
        document.getElementById('char2-yellow').textContent = data.yellow_flags_2;
        document.getElementById('char1-green').textContent = data.green_flags_1;
        document.getElementById('char2-green').textContent = data.green_flags_2;

        // Update names in flag stats
        ['red', 'yellow', 'green'].forEach(color => {
            document.getElementById(`char1-${color}-name`).textContent = data.character_1_name;
            document.getElementById(`char2-${color}-name`).textContent = data.character_2_name;
        });

        // Update headers
        document.getElementById('only1-header').textContent = data.character_1_name;
        document.getElementById('only2-header').textContent = data.character_2_name;

        // Display metrics if available
        if (data.metrics_1 || data.metrics_2) {
            displayMetrics(data);
        }

        // Display corp history if available
        if (data.shared_corps || data.unique_corps_1 || data.unique_corps_2) {
            displayCorpHistory(data);
        }

        // Populate flag lists
        populateFlagList('shared-flags', data.shared_flags, 'No shared flags');
        populateFlagList('only-in-1', data.only_in_1, 'No unique flags');
        populateFlagList('only-in-2', data.only_in_2, 'No unique flags');

        // Update report links
        document.getElementById('view-report-1').href = `/reports/${data.report_1_id}`;
        document.getElementById('view-report-2').href = `/reports/${data.report_2_id}`;
    }

    function displayMetrics(data) {
        const section = document.getElementById('metrics-section');
        section.style.display = 'flex';

        // Update table headers
        document.getElementById('metrics-char1-header').textContent = data.character_1_name;
        document.getElementById('metrics-char2-header').textContent = data.character_2_name;

        const m1 = data.metrics_1 || {};
        const m2 = data.metrics_2 || {};

        // Build metrics table
        const metricsRows = [
            { label: 'Character Age', v1: m1.character_age_days ? `${m1.character_age_days} days` : '-', v2: m2.character_age_days ? `${m2.character_age_days} days` : '-' },
            { label: 'Security Status', v1: m1.security_status ?? '-', v2: m2.security_status ?? '-' },
            { label: 'Total Kills', v1: m1.kills_total ?? '-', v2: m2.kills_total ?? '-' },
            { label: 'Kills (90d)', v1: m1.kills_90d ?? '-', v2: m2.kills_90d ?? '-' },
            { label: 'Total Deaths', v1: m1.deaths_total ?? '-', v2: m2.deaths_total ?? '-' },
            { label: 'Solo Kills', v1: m1.solo_kills ?? '-', v2: m2.solo_kills ?? '-' },
            { label: 'AWOX Kills', v1: m1.awox_kills ?? '-', v2: m2.awox_kills ?? '-', highlight: true },
            { label: 'ISK Destroyed', v1: formatISK(m1.isk_destroyed), v2: formatISK(m2.isk_destroyed) },
            { label: 'ISK Lost', v1: formatISK(m1.isk_lost), v2: formatISK(m2.isk_lost) },
            { label: 'Danger Ratio', v1: m1.danger_ratio ? `${m1.danger_ratio.toFixed(1)}%` : '-', v2: m2.danger_ratio ? `${m2.danger_ratio.toFixed(1)}%` : '-' },
            { label: 'Corp Count', v1: m1.corp_count ?? '-', v2: m2.corp_count ?? '-' },
            { label: 'Recent Corp Changes', v1: m1.recent_corp_changes ?? '-', v2: m2.recent_corp_changes ?? '-', highlight: true },
            { label: 'Avg Corp Tenure', v1: m1.avg_corp_tenure_days ? `${m1.avg_corp_tenure_days} days` : '-', v2: m2.avg_corp_tenure_days ? `${m2.avg_corp_tenure_days} days` : '-' },
            { label: 'Timezone', v1: m1.primary_timezone ?? '-', v2: m2.primary_timezone ?? '-' },
            { label: 'Activity Trend', v1: m1.activity_trend ?? '-', v2: m2.activity_trend ?? '-' },
        ];

        const tbody = document.getElementById('metrics-table');
        tbody.innerHTML = metricsRows.map(row => `
            <tr ${row.highlight ? 'class="table-warning"' : ''}>
                <td>${row.label}</td>
                <td class="text-end">${row.v1}</td>
                <td class="text-end">${row.v2}</td>
            </tr>
        `).join('');

        // Render radar chart
        renderRadarChart(data.character_1_name, data.character_2_name, m1, m2);
    }

    function renderRadarChart(name1, name2, m1, m2) {
        const ctx = document.getElementById('radarChart').getContext('2d');

        // Destroy existing chart if any
        if (radarChart) {
            radarChart.destroy();
        }

        // Normalize metrics for radar chart (0-100 scale)
        const normalize = (val, max) => val ? Math.min(100, (val / max) * 100) : 0;

        const labels = ['Kills', 'Deaths', 'Solo%', 'ISK Destroyed', 'Danger', 'Corps'];
        const data1 = [
            normalize(m1.kills_total, 1000),
            normalize(m1.deaths_total, 500),
            m1.kills_total > 0 ? (m1.solo_kills / m1.kills_total) * 100 : 0,
            normalize(m1.isk_destroyed, 100000000000), // 100B
            m1.danger_ratio ?? 0,
            normalize(m1.corp_count, 20),
        ];
        const data2 = [
            normalize(m2.kills_total, 1000),
            normalize(m2.deaths_total, 500),
            m2.kills_total > 0 ? (m2.solo_kills / m2.kills_total) * 100 : 0,
            normalize(m2.isk_destroyed, 100000000000),
            m2.danger_ratio ?? 0,
            normalize(m2.corp_count, 20),
        ];

        radarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: name1,
                        data: data1,
                        backgroundColor: 'rgba(233, 69, 96, 0.2)',
                        borderColor: 'rgba(233, 69, 96, 1)',
                        pointBackgroundColor: 'rgba(233, 69, 96, 1)',
                        borderWidth: 2,
                    },
                    {
                        label: name2,
                        data: data2,
                        backgroundColor: 'rgba(13, 202, 240, 0.2)',
                        borderColor: 'rgba(13, 202, 240, 1)',
                        pointBackgroundColor: 'rgba(13, 202, 240, 1)',
                        borderWidth: 2,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        pointLabels: { color: '#a0a0a0' },
                        ticks: { display: false },
                        suggestedMin: 0,
                        suggestedMax: 100,
                    },
                },
                plugins: {
                    legend: {
                        labels: { color: '#a0a0a0' },
                    },
                },
            },
        });
    }

    function displayCorpHistory(data) {
        const section = document.getElementById('corp-history-section');

        const hasCorps = (data.shared_corps && data.shared_corps.length > 0) ||
                        (data.unique_corps_1 && data.unique_corps_1.length > 0) ||
                        (data.unique_corps_2 && data.unique_corps_2.length > 0);

        if (!hasCorps) return;

        section.style.display = 'block';

        // Update names
        document.getElementById('corps-char1-name').textContent = data.character_1_name;
        document.getElementById('corps-char2-name').textContent = data.character_2_name;

        // Populate lists
        populateCorpList('shared-corps', data.shared_corps, 'No shared corporations');
        populateCorpList('unique-corps-1', data.unique_corps_1, 'No unique corporations');
        populateCorpList('unique-corps-2', data.unique_corps_2, 'No unique corporations');

        // Update counts
        document.getElementById('shared-corps-count').textContent = data.shared_corps?.length ?? 0;
        document.getElementById('unique-corps-1-count').textContent = data.unique_corps_1?.length ?? 0;
        document.getElementById('unique-corps-2-count').textContent = data.unique_corps_2?.length ?? 0;
    }

    function populateCorpList(elementId, corps, emptyText) {
        const container = document.getElementById(elementId);

        if (!corps || corps.length === 0) {
            container.innerHTML = `<p class="text-muted small mb-0">${emptyText}</p>`;
            return;
        }

        container.innerHTML = corps.map(corp => `
            <div class="d-flex justify-content-between align-items-center py-1 border-bottom" style="border-color: var(--eve-border) !important;">
                <span class="small">${corp.corp_name}</span>
                <small class="text-muted">${corp.char_1_joined || corp.char_2_joined || ''}</small>
            </div>
        `).join('');
    }

    function formatISK(amount) {
        if (!amount || amount === 0) return '-';
        if (amount >= 1000000000000) return `${(amount / 1000000000000).toFixed(1)}T`;
        if (amount >= 1000000000) return `${(amount / 1000000000).toFixed(1)}B`;
        if (amount >= 1000000) return `${(amount / 1000000).toFixed(1)}M`;
        if (amount >= 1000) return `${(amount / 1000).toFixed(1)}K`;
        return amount.toString();
    }

    function setRiskBadge(elementId, risk) {
        const el = document.getElementById(elementId);
        const colors = {
            'RED': 'danger',
            'YELLOW': 'warning',
            'GREEN': 'success',
        };
        const color = colors[risk] || 'secondary';
        el.innerHTML = `<span class="badge bg-${color} fs-5">${risk}</span>`;
    }

    function populateFlagList(elementId, flags, emptyText) {
        const list = document.getElementById(elementId);
        list.innerHTML = '';

        if (!flags || flags.length === 0) {
            list.innerHTML = `<li class="list-group-item text-muted text-center py-4">${emptyText}</li>`;
            return;
        }

        flags.forEach(flag => {
            const colors = {
                'red': 'danger',
                'yellow': 'warning',
                'green': 'success',
            };
            const color = colors[flag.severity] || 'secondary';
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                <span>${flag.title}</span>
                <span class="badge bg-${color}">${flag.severity.toUpperCase()}</span>
            `;
            list.appendChild(li);
        });
    }
});
</script>
{% endblock %}
