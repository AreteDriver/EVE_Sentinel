{% extends "base.html" %}

{% block title %}Compare Characters - EVE Sentinel{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-arrow-left-right me-2"></i>Compare Characters</h1>
    <p class="text-muted mb-0">Side-by-side analysis comparison</p>
</div>

<!-- Comparison Form -->
<div class="card card-sentinel mb-4">
    <div class="card-header">
        <i class="bi bi-search me-2"></i>Select Characters to Compare
    </div>
    <div class="card-body">
        <form id="compare-form">
            <div class="row g-3">
                <div class="col-md-5">
                    <label class="form-label">Character 1</label>
                    <input type="text" class="form-control form-control-sentinel"
                           id="char1-input" placeholder="Character name or ID..." required>
                    <select class="form-select form-select-sentinel mt-2" id="char1-select">
                        <option value="">Or select from recent reports...</option>
                        {% for report in recent_reports %}
                        <option value="{{ report.character_id }}">
                            {{ report.character_name }} ({{ report.overall_risk.value }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-center justify-content-center">
                    <i class="bi bi-arrow-left-right fs-2 text-muted"></i>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Character 2</label>
                    <input type="text" class="form-control form-control-sentinel"
                           id="char2-input" placeholder="Character name or ID..." required>
                    <select class="form-select form-select-sentinel mt-2" id="char2-select">
                        <option value="">Or select from recent reports...</option>
                        {% for report in recent_reports %}
                        <option value="{{ report.character_id }}">
                            {{ report.character_name }} ({{ report.overall_risk.value }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="mt-3 text-center">
                <button type="submit" class="btn btn-sentinel btn-lg">
                    <i class="bi bi-arrow-left-right me-2"></i>Compare
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Comparison Results (populated via JavaScript) -->
<div id="comparison-result" style="display: none;">
    <!-- Header with names and risk -->
    <div class="row g-3 mb-4">
        <div class="col-md-5">
            <div class="card card-sentinel h-100" id="char1-card">
                <div class="card-body text-center">
                    <h4 id="char1-name">-</h4>
                    <div id="char1-risk" class="fs-3 mb-2">-</div>
                    <div class="text-muted">
                        Confidence: <span id="char1-confidence">-</span>%
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2 d-flex align-items-center justify-content-center">
            <div id="risk-comparison" class="text-center">
                <i class="bi bi-equals fs-1 text-muted"></i>
            </div>
        </div>
        <div class="col-md-5">
            <div class="card card-sentinel h-100" id="char2-card">
                <div class="card-body text-center">
                    <h4 id="char2-name">-</h4>
                    <div id="char2-risk" class="fs-3 mb-2">-</div>
                    <div class="text-muted">
                        Confidence: <span id="char2-confidence">-</span>%
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Flag Statistics -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card card-sentinel">
                <div class="card-header bg-danger bg-opacity-25">
                    <i class="bi bi-exclamation-triangle me-2"></i>Red Flags
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-5">
                            <div class="fs-2 text-danger" id="char1-red">0</div>
                            <small class="text-muted" id="char1-red-name">Char 1</small>
                        </div>
                        <div class="col-2 d-flex align-items-center justify-content-center">
                            <span class="text-muted">vs</span>
                        </div>
                        <div class="col-5">
                            <div class="fs-2 text-danger" id="char2-red">0</div>
                            <small class="text-muted" id="char2-red-name">Char 2</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-sentinel">
                <div class="card-header bg-warning bg-opacity-25">
                    <i class="bi bi-exclamation-circle me-2"></i>Yellow Flags
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-5">
                            <div class="fs-2 text-warning" id="char1-yellow">0</div>
                            <small class="text-muted" id="char1-yellow-name">Char 1</small>
                        </div>
                        <div class="col-2 d-flex align-items-center justify-content-center">
                            <span class="text-muted">vs</span>
                        </div>
                        <div class="col-5">
                            <div class="fs-2 text-warning" id="char2-yellow">0</div>
                            <small class="text-muted" id="char2-yellow-name">Char 2</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-sentinel">
                <div class="card-header bg-success bg-opacity-25">
                    <i class="bi bi-check-circle me-2"></i>Green Flags
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-5">
                            <div class="fs-2 text-success" id="char1-green">0</div>
                            <small class="text-muted" id="char1-green-name">Char 1</small>
                        </div>
                        <div class="col-2 d-flex align-items-center justify-content-center">
                            <span class="text-muted">vs</span>
                        </div>
                        <div class="col-5">
                            <div class="fs-2 text-success" id="char2-green">0</div>
                            <small class="text-muted" id="char2-green-name">Char 2</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Flag Details -->
    <div class="row g-3">
        <!-- Shared Flags -->
        <div class="col-md-4">
            <div class="card card-sentinel h-100">
                <div class="card-header">
                    <i class="bi bi-intersect me-2"></i>Shared Flags
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush" id="shared-flags">
                        <li class="list-group-item text-muted text-center py-4">No shared flags</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Only in Character 1 -->
        <div class="col-md-4">
            <div class="card card-sentinel h-100">
                <div class="card-header">
                    <i class="bi bi-box-arrow-left me-2"></i>Only in <span id="only1-header">Character 1</span>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush" id="only-in-1">
                        <li class="list-group-item text-muted text-center py-4">No unique flags</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Only in Character 2 -->
        <div class="col-md-4">
            <div class="card card-sentinel h-100">
                <div class="card-header">
                    <i class="bi bi-box-arrow-right me-2"></i>Only in <span id="only2-header">Character 2</span>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush" id="only-in-2">
                        <li class="list-group-item text-muted text-center py-4">No unique flags</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- View Full Reports -->
    <div class="mt-4 text-center">
        <a id="view-report-1" href="#" class="btn btn-outline-sentinel me-2">
            <i class="bi bi-file-text me-1"></i>View Report 1
        </a>
        <a id="view-report-2" href="#" class="btn btn-outline-sentinel">
            <i class="bi bi-file-text me-1"></i>View Report 2
        </a>
    </div>
</div>

<!-- Loading State -->
<div id="loading-state" class="text-center py-5" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Comparing characters...</p>
</div>

<!-- Error State -->
<div id="error-state" class="alert alert-danger" style="display: none;">
    <i class="bi bi-exclamation-triangle me-2"></i>
    <span id="error-message">An error occurred</span>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('compare-form');
    const char1Input = document.getElementById('char1-input');
    const char2Input = document.getElementById('char2-input');
    const char1Select = document.getElementById('char1-select');
    const char2Select = document.getElementById('char2-select');

    // Sync select to input
    char1Select.addEventListener('change', function() {
        if (this.value) char1Input.value = this.value;
    });
    char2Select.addEventListener('change', function() {
        if (this.value) char2Input.value = this.value;
    });

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const char1 = char1Input.value.trim();
        const char2 = char2Input.value.trim();

        if (!char1 || !char2) return;

        // Show loading
        document.getElementById('comparison-result').style.display = 'none';
        document.getElementById('error-state').style.display = 'none';
        document.getElementById('loading-state').style.display = 'block';

        try {
            const response = await fetch('/api/v1/reports/compare', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    character_id_1: isNaN(char1) ? null : parseInt(char1),
                    character_id_2: isNaN(char2) ? null : parseInt(char2),
                }),
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'Comparison failed');
            }

            const data = await response.json();
            displayComparison(data);

        } catch (error) {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('error-message').textContent = error.message;
            document.getElementById('error-state').style.display = 'block';
        }
    });

    function displayComparison(data) {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('comparison-result').style.display = 'block';

        // Character 1 info
        document.getElementById('char1-name').textContent = data.character_1_name;
        document.getElementById('char1-confidence').textContent = Math.round(data.report_1_confidence * 100);
        setRiskBadge('char1-risk', data.report_1_risk);

        // Character 2 info
        document.getElementById('char2-name').textContent = data.character_2_name;
        document.getElementById('char2-confidence').textContent = Math.round(data.report_2_confidence * 100);
        setRiskBadge('char2-risk', data.report_2_risk);

        // Risk comparison icon
        const riskComp = document.getElementById('risk-comparison');
        if (data.risk_difference === 'same') {
            riskComp.innerHTML = '<i class="bi bi-equals fs-1 text-muted"></i><div class="small text-muted">Same Risk</div>';
        } else if (data.risk_difference === '1_higher') {
            riskComp.innerHTML = '<i class="bi bi-arrow-left fs-1 text-danger"></i><div class="small text-muted">Higher Risk</div>';
        } else {
            riskComp.innerHTML = '<i class="bi bi-arrow-right fs-1 text-danger"></i><div class="small text-muted">Higher Risk</div>';
        }

        // Flag counts
        document.getElementById('char1-red').textContent = data.red_flags_1;
        document.getElementById('char2-red').textContent = data.red_flags_2;
        document.getElementById('char1-yellow').textContent = data.yellow_flags_1;
        document.getElementById('char2-yellow').textContent = data.yellow_flags_2;
        document.getElementById('char1-green').textContent = data.green_flags_1;
        document.getElementById('char2-green').textContent = data.green_flags_2;

        // Update names in flag stats
        ['red', 'yellow', 'green'].forEach(color => {
            document.getElementById(`char1-${color}-name`).textContent = data.character_1_name;
            document.getElementById(`char2-${color}-name`).textContent = data.character_2_name;
        });

        // Update headers
        document.getElementById('only1-header').textContent = data.character_1_name;
        document.getElementById('only2-header').textContent = data.character_2_name;

        // Populate flag lists
        populateFlagList('shared-flags', data.shared_flags, 'No shared flags');
        populateFlagList('only-in-1', data.only_in_1, 'No unique flags');
        populateFlagList('only-in-2', data.only_in_2, 'No unique flags');

        // Update report links
        document.getElementById('view-report-1').href = `/reports/${data.report_1_id}`;
        document.getElementById('view-report-2').href = `/reports/${data.report_2_id}`;
    }

    function setRiskBadge(elementId, risk) {
        const el = document.getElementById(elementId);
        const colors = {
            'RED': 'danger',
            'YELLOW': 'warning',
            'GREEN': 'success',
        };
        const color = colors[risk] || 'secondary';
        el.innerHTML = `<span class="badge bg-${color} fs-5">${risk}</span>`;
    }

    function populateFlagList(elementId, flags, emptyText) {
        const list = document.getElementById(elementId);
        list.innerHTML = '';

        if (!flags || flags.length === 0) {
            list.innerHTML = `<li class="list-group-item text-muted text-center py-4">${emptyText}</li>`;
            return;
        }

        flags.forEach(flag => {
            const colors = {
                'red': 'danger',
                'yellow': 'warning',
                'green': 'success',
            };
            const color = colors[flag.severity] || 'secondary';
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                <span>${flag.title}</span>
                <span class="badge bg-${color}">${flag.severity.toUpperCase()}</span>
            `;
            list.appendChild(li);
        });
    }
});
</script>
{% endblock %}
