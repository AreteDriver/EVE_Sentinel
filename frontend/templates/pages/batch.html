{% extends "base.html" %}

{% block title %}Batch Analysis - EVE Sentinel{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-collection me-2"></i>Batch Analysis</h1>
    <p class="text-muted mb-0">Analyze multiple characters at once</p>
</div>

<div class="row">
    <div class="col-lg-6">
        <!-- Input Methods -->
        <div class="card card-sentinel mb-4">
            <div class="card-header">
                <i class="bi bi-input-cursor-text me-2"></i>Character Input
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="text-tab" data-bs-toggle="tab"
                                data-bs-target="#text-input" type="button" role="tab">
                            <i class="bi bi-textarea-t me-1"></i>Text Input
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="csv-tab" data-bs-toggle="tab"
                                data-bs-target="#csv-input" type="button" role="tab">
                            <i class="bi bi-filetype-csv me-1"></i>CSV Upload
                        </button>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Text Input Tab -->
                    <div class="tab-pane fade show active" id="text-input" role="tabpanel">
                        <div class="mb-3">
                            <label for="characters-text" class="form-label">
                                Enter character names or IDs (one per line)
                            </label>
                            <textarea id="characters-text" class="form-control" rows="10"
                                      placeholder="Character Name 1&#10;Character Name 2&#10;12345678&#10;..."
                                      style="background: var(--eve-surface); border-color: var(--eve-border); color: var(--eve-text);"></textarea>
                            <div class="form-text text-muted">
                                Mix of names and IDs is supported. Names will be resolved automatically.
                            </div>
                        </div>
                    </div>

                    <!-- CSV Upload Tab -->
                    <div class="tab-pane fade" id="csv-input" role="tabpanel">
                        <div class="mb-3">
                            <label for="csv-file" class="form-label">Upload CSV file</label>
                            <input type="file" id="csv-file" class="form-control" accept=".csv,.txt"
                                   style="background: var(--eve-surface); border-color: var(--eve-border); color: var(--eve-text);">
                            <div class="form-text text-muted">
                                CSV should have character names or IDs in the first column.
                                Header row is optional.
                            </div>
                        </div>
                        <div id="csv-preview" class="d-none">
                            <h6 class="text-muted">Preview (<span id="csv-count">0</span> characters):</h6>
                            <div id="csv-preview-list" class="border rounded p-2 mb-3"
                                 style="max-height: 200px; overflow-y: auto; background: var(--eve-bg); border-color: var(--eve-border) !important;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="requested-by" class="form-label">Requested By (optional)</label>
                    <input type="text" id="requested-by" class="form-control"
                           placeholder="Your name or identifier"
                           style="background: var(--eve-surface); border-color: var(--eve-border); color: var(--eve-text);">
                </div>

                <button type="button" id="start-batch" class="btn btn-sentinel btn-lg w-100">
                    <i class="bi bi-play-circle me-2"></i>Start Batch Analysis
                </button>
            </div>
        </div>

        <!-- Tips -->
        <div class="card card-sentinel">
            <div class="card-header">
                <i class="bi bi-lightbulb me-2"></i>Batch Tips
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li class="mb-2">Maximum 50 characters per batch</li>
                    <li class="mb-2">Characters are analyzed in parallel for speed</li>
                    <li class="mb-2">Failed analyses won't stop the batch</li>
                    <li class="mb-2">Results are saved and appear in Reports</li>
                    <li class="mb-2">Webhook notification sent when batch completes</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <!-- Progress Section -->
        <div id="batch-progress" class="d-none">
            <div class="card card-sentinel mb-4">
                <div class="card-header">
                    <i class="bi bi-hourglass-split me-2"></i>Analysis Progress
                </div>
                <div class="card-body">
                    <div class="progress mb-3" style="height: 25px; background: var(--eve-surface);">
                        <div id="progress-bar" class="progress-bar bg-success" role="progressbar"
                             style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            0%
                        </div>
                    </div>
                    <div class="d-flex justify-content-between text-muted">
                        <span><i class="bi bi-check-circle text-success me-1"></i>Completed: <span id="completed-count">0</span></span>
                        <span><i class="bi bi-x-circle text-danger me-1"></i>Failed: <span id="failed-count">0</span></span>
                        <span><i class="bi bi-clock me-1"></i>Remaining: <span id="remaining-count">0</span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="batch-results">
            <div class="card card-sentinel">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-list-check me-2"></i>Results</span>
                    <span id="results-summary" class="badge bg-secondary d-none">0 results</span>
                </div>
                <div class="card-body">
                    <div id="results-placeholder" class="empty-state">
                        <i class="bi bi-arrow-left-circle"></i>
                        <p class="mb-0">Enter characters and click Start to begin batch analysis</p>
                    </div>
                    <div id="results-list" class="d-none">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const MAX_BATCH_SIZE = 50;
let characterList = [];

// Parse text input
function parseTextInput() {
    const text = document.getElementById('characters-text').value;
    const lines = text.split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0);
    return [...new Set(lines)]; // Remove duplicates
}

// Handle CSV file upload
document.getElementById('csv-file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(event) {
        const text = event.target.result;
        const lines = text.split('\n')
            .map(line => line.split(',')[0].trim().replace(/"/g, ''))
            .filter(line => line.length > 0 && !/^(character|name|id)/i.test(line));

        characterList = [...new Set(lines)];

        // Show preview
        const previewDiv = document.getElementById('csv-preview');
        const previewList = document.getElementById('csv-preview-list');
        const countSpan = document.getElementById('csv-count');

        previewDiv.classList.remove('d-none');
        countSpan.textContent = characterList.length;
        previewList.innerHTML = characterList.slice(0, 20)
            .map(c => `<div style="color: var(--eve-text);">${escapeHtml(c)}</div>`)
            .join('') + (characterList.length > 20 ? `<div class="text-muted">...and ${characterList.length - 20} more</div>` : '');
    };
    reader.readAsText(file);
});

// Start batch analysis
document.getElementById('start-batch').addEventListener('click', async function() {
    // Get characters from active tab
    const activeTab = document.querySelector('.tab-pane.active').id;
    let characters;

    if (activeTab === 'text-input') {
        characters = parseTextInput();
    } else {
        characters = characterList;
    }

    if (characters.length === 0) {
        alert('Please enter at least one character');
        return;
    }

    if (characters.length > MAX_BATCH_SIZE) {
        alert(`Maximum ${MAX_BATCH_SIZE} characters per batch. You entered ${characters.length}.`);
        return;
    }

    // Resolve names to IDs
    const btn = document.getElementById('start-batch');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Resolving names...';

    try {
        const characterIds = await resolveCharacters(characters);

        if (characterIds.length === 0) {
            alert('No valid characters found');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-play-circle me-2"></i>Start Batch Analysis';
            return;
        }

        // Show progress
        document.getElementById('batch-progress').classList.remove('d-none');
        document.getElementById('results-placeholder').classList.add('d-none');
        document.getElementById('results-list').classList.remove('d-none');
        document.getElementById('results-list').innerHTML = '';

        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analyzing...';

        // Start batch analysis
        await runBatchAnalysis(characterIds);

    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-play-circle me-2"></i>Start Batch Analysis';
    }
});

async function resolveCharacters(characters) {
    const ids = [];

    for (const char of characters) {
        if (/^\d+$/.test(char)) {
            ids.push(parseInt(char));
        } else {
            // Search by name
            try {
                const response = await fetch(`https://esi.evetech.net/latest/universe/ids/?datasource=tranquility`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify([char])
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.characters && data.characters.length > 0) {
                        ids.push(data.characters[0].id);
                    }
                }
            } catch (e) {
                console.error(`Failed to resolve ${char}:`, e);
            }
        }
    }

    return ids;
}

async function runBatchAnalysis(characterIds) {
    const requestedBy = document.getElementById('requested-by').value || null;
    const total = characterIds.length;

    // Update initial counts
    document.getElementById('remaining-count').textContent = total;
    document.getElementById('completed-count').textContent = '0';
    document.getElementById('failed-count').textContent = '0';

    try {
        const response = await fetch('/api/v1/analyze/batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                character_ids: characterIds,
                requested_by: requestedBy
            })
        });

        if (!response.ok) {
            throw new Error('Batch analysis failed');
        }

        const result = await response.json();

        // Update progress to 100%
        updateProgress(100);
        document.getElementById('completed-count').textContent = result.completed;
        document.getElementById('failed-count').textContent = result.failed;
        document.getElementById('remaining-count').textContent = '0';

        // Display results
        displayResults(result);

    } catch (error) {
        console.error('Batch analysis error:', error);
        throw error;
    }
}

function updateProgress(percent) {
    const bar = document.getElementById('progress-bar');
    bar.style.width = percent + '%';
    bar.textContent = Math.round(percent) + '%';
    bar.setAttribute('aria-valuenow', percent);
}

function displayResults(result) {
    const resultsList = document.getElementById('results-list');
    const summary = document.getElementById('results-summary');

    summary.classList.remove('d-none');
    summary.textContent = `${result.completed} completed, ${result.failed} failed`;

    if (result.reports.length === 0) {
        resultsList.innerHTML = '<div class="text-muted text-center py-3">No results</div>';
        return;
    }

    // Sort by risk (red first)
    const sorted = result.reports.sort((a, b) => {
        const order = { 'RED': 0, 'YELLOW': 1, 'GREEN': 2, 'UNKNOWN': 3 };
        return order[a.overall_risk] - order[b.overall_risk];
    });

    resultsList.innerHTML = sorted.map(report => `
        <div class="border-bottom py-2" style="border-color: var(--eve-border) !important;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <a href="/reports/${report.report_id}" class="character-link fw-bold">
                        ${escapeHtml(report.character_name)}
                    </a>
                    <div class="small text-muted">
                        <span class="text-danger">${report.red_flag_count} red</span> |
                        <span class="text-warning">${report.yellow_flag_count} yellow</span> |
                        <span class="text-success">${report.green_flag_count} green</span>
                    </div>
                </div>
                <div>
                    ${getRiskBadge(report.overall_risk)}
                </div>
            </div>
        </div>
    `).join('');
}

function getRiskBadge(risk) {
    const badges = {
        'RED': '<span class="badge bg-danger"><i class="bi bi-exclamation-triangle-fill me-1"></i>RED</span>',
        'YELLOW': '<span class="badge bg-warning text-dark"><i class="bi bi-exclamation-circle-fill me-1"></i>YELLOW</span>',
        'GREEN': '<span class="badge bg-success"><i class="bi bi-check-circle-fill me-1"></i>GREEN</span>',
        'UNKNOWN': '<span class="badge bg-secondary">UNKNOWN</span>'
    };
    return badges[risk] || badges['UNKNOWN'];
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
